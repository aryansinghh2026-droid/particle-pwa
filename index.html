<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hand Gesture Particle Universe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<meta http-equiv="Content-Security-Policy"
content="default-src * blob: data: 'self' 'unsafe-inline' 'unsafe-eval';
media-src * blob:;">

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: black;
  touch-action: none;
}
#hint {
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-family: monospace;
  font-size: 12px;
  opacity: 0.75;
  z-index: 10;
}
video { display: none; }
</style>
</head>

<body>
<div id="hint">Open = Expand • Pinch = Color • Swipe = Shape</div>
<video id="video" autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 50);
camera.position.z = 4;

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,1.3));
document.body.appendChild(renderer.domElement);

const COUNT = 3500;
const geometry = new THREE.BufferGeometry();
const pos = new Float32Array(COUNT*3);
const col = new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
  pos[i*3]=(Math.random()-.5)*2;
  pos[i*3+1]=(Math.random()-.5)*2;
  pos[i*3+2]=(Math.random()-.5)*2;
  col[i*3]=1; col[i*3+1]=.3; col[i*3+2]=.6;
}

geometry.setAttribute("position",new THREE.BufferAttribute(pos,3));
geometry.setAttribute("color",new THREE.BufferAttribute(col,3));

const particles=new THREE.Points(
  geometry,
  new THREE.PointsMaterial({size:.03,vertexColors:true})
);
scene.add(particles);

const shapes=["heart","saturn","flower","firework"];
let shapeIndex=0;

function applyShape(type){
  for(let i=0;i<COUNT;i++){
    let t=Math.random()*Math.PI*2;
    if(type==="heart"){
      pos[i*3]=.8*Math.sin(t)**3;
      pos[i*3+1]=.6*(Math.cos(t)-Math.cos(2*t)/2);
      pos[i*3+2]=(Math.random()-.5)*.2;
    }
    if(type==="saturn"){
      pos[i*3]=Math.cos(t)*1.2;
      pos[i*3+1]=(Math.random()-.5)*.1;
      pos[i*3+2]=Math.sin(t)*1.2;
    }
    if(type==="flower"){
      let r=Math.cos(5*t);
      pos[i*3]=r*Math.cos(t);
      pos[i*3+1]=r*Math.sin(t);
      pos[i*3+2]=(Math.random()-.5)*.3;
    }
    if(type==="firework"){
      pos[i*3]=(Math.random()-.5)*2;
      pos[i*3+1]=(Math.random()-.5)*2;
      pos[i*3+2]=(Math.random()-.5)*2;
    }
  }
  geometry.attributes.position.needsUpdate=true;
}

const video=document.getElementById("video");
const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:1,modelComplexity:0,minDetectionConfidence:.6,minTrackingConfidence:.6});

let lastX=null;
hands.onResults(r=>{
  if(!r.multiHandLandmarks)return;
  const lm=r.multiHandLandmarks[0];
  const d=Math.hypot(lm[4].x-lm[8].x,lm[4].y-lm[8].y);

  let s=d>.15?1.01:.99;
  for(let i=0;i<pos.length;i++)pos[i]*=s;

  if(d<.05){
    for(let i=0;i<col.length;i+=3){
      col[i]=Math.random(); col[i+1]=Math.random(); col[i+2]=Math.random();
    }
    geometry.attributes.color.needsUpdate=true;
  }

  if(lastX!==null&&Math.abs(lm[0].x-lastX)>.25){
    shapeIndex=(shapeIndex+1)%shapes.length;
    applyShape(shapes[shapeIndex]);
    lastX=null;
  } else lastX=lm[0].x;
});

new Camera(video,{onFrame:async()=>hands.send({image:video}),width:640,height:480}).start();

function animate(){
  requestAnimationFrame(animate);
  particles.rotation.y+=.002;
  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js'));
}
</script>
</body>
  </html>
